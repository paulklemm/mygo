---
title: GO-Term Analysis
output:
  html_notebook:
    toc: yes
    toc_float: yes
params:
  dat: ''
  dev: 'TRUE'
  output_path: '.'
  save_excel: 'TRUE'
  significance_cutoff: 0.05
---

# Setup

```{r setup}
library(mygo)
library(magrittr)
library(tibble)
library(knitr)

# Debug
# DEBUG Statements
if (!exists('params')) {
  params <- list()
  params$dat <- readr::read_tsv('test/geneexp_F_CPu.tsv') %>% dplyr::rename(fc = `log2(fold_change)`) %>% dplyr::mutate(Symbol = ensembl_gene_id) %>% dplyr::filter(status == "OK") %>% dplyr::select(ensembl_gene_id, q_value, fc)
  params$output_path <- '.'
  params$save_excel <- TRUE
  params$significance_cutoff <- 0.05
}

paste0("Settings: dev: ", params$dev, ", output_path: ", params$output_path, ", save_excel: ", params$save_excel, ", significance_cutoff: ", params$significance_cutoff)

print(params$dat)

if (!('q_value' %in% colnames(params$dat))) {
  stop('Column `q_value` not found in data frame')
} else if (!('fc' %in% colnames(params$dat))) {
  stop('Column `fc` not found in data frame')
}

# Filter significant genes
if (!('EntrezID' %in% colnames(params$dat))) {
  warning('EntrezID not available in data frame. Attaching it manually')
  dat <- params$dat %>% ensembl_to_entrez(ensembl_id_name = "ensembl_gene_id", keep_only_rows_with_entrez = TRUE, drop_duplicates = TRUE)
  
  # Get regulated genes that don't have a EntrezID
  # https://github.sf.mpg.de/bruening-lab/2018-01-Weiyi-Differential-Gene-Expression-Analysis/blob/master/Analysis_DESeq.Rmd
  print("Regulated genes that do not map to a EntrezID")
  params$dat %>%
    dplyr::filter(q_value <= params$significance_cutoff) %>%
    dplyr::anti_join(dat %>% dplyr::filter(q_value <= params$significance_cutoff), by = "ensembl_gene_id") %>%
    kable()
  
  print("Check for genes with duplicated entries. We will consider the ones with the lowest p-value")
  dat %<>% add_is_duplicated("EntrezID")
  dat %>%
    dplyr::filter(EntrezID_is_duplicated == T) %>%
    kable()
  
  dat %<>%
    # For duplicated Entrez IDs only keep the ones with the lowest p-value
    dplyr::group_by(EntrezID) %>%
    dplyr::summarize(q_value = min(q_value)) %>%
    # Join back with the original data set in which we will also remove entries that have the same EntrwzID, q-value and FC
    # Because it can happen that a EntrezID maps to different Ensembl-IDs
    dplyr::inner_join(dat %>% dplyr::distinct(EntrezID, q_value, fc, .keep_all = TRUE))
  # Finally check if we still have problems regarding multiple entries
  .temp_multiple_entries <- dat %>% add_is_duplicated('EntrezID') %>% dplyr::filter(EntrezID_is_duplicated == T)
  if (nrow(.temp_multiple_entries) > 0) {
    warning("Duplicates per EntrezID, check input data")
    .temp_multiple_entries %>% kable()
  }
  # Remove obsolete rows
  dat %<>% dplyr::select(-EntrezID_is_duplicated)
}
# Get names vector from EntrezIDs
dat %<>% attach_gene_symbol_from_entrez()
# Named double vector of fold changes named after the gene symbol
fc_symbol <- dat %>% .$fc %>% as.double() %>% `names<-`(dat$Symbol)
```

# GO-Term Analysis

## All

```{r get_go_ontologies, dev='svg', fig.width=15}
# Expect a data set containing q_values and Entrez/Ensembl IDs
dat_goterms <- dat %>% get_go_all_ontologies(significance_cutoff <- params$significance_cutoff)
dat_goterms_simplified <- simplify_ontologies(dat_goterms)
dat_goterms %>% plot_all_ontologies(fc_symbol)
```

## Simplified

```{r print_go_ontologies, dev='svg', fig.width=15}
dat_goterms_simplified %>% plot_all_ontologies(fc_symbol)
```

# Gene Set Enrichment GO Analysis

```{r gse_all, dev='svg', fig.width=15}
dat_gse_go <- dat %>% get_gse_all_ontologies()
dat_gse_go %>% plot_all_ontologies(fc_symbol)
```

# Gene Set Enrichtment KEGG Pathways

```{r gse_kegg_all, dev='svg', fig.width=15}
dat_gse_kegg <- dat %>% get_kegg_all_ontologies()
dat_gse_kegg %>% plot_all_ontologies(fc_symbol)
```

# Export Result

```{r export_result}
if (params$save_excel) {
  export_go_terms_to_excel(
    go_ontologies        = dat_goterms,
    go_ontologies_simple = dat_goterms_simplified,
    gse_ontologies       = dat_gse_go,
    kegg_ontologies      = dat_gse_kegg,
    path                 = paste0(params$output_path, '/go_terms.xlsx')
  )
}
```